<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Canvas Editor</title>
    <link rel="stylesheet/less" type="text/css" href="libs/custom/custom.less" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/less.js/2.7.1/less.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

</head>

<body>

    <div id="content">
                            <div id='toolbar' class="toolbar">
                            </div>
                            <div id='header' class="toolbar">
                              <button onclick='header.close()'> <i class="fa fa-times" aria-hidden="true"></i> </button><span class='title' id='headerTitle'> </span>
                            </div>
                            <div class="image-container">
                              <canvas id='theCanvas'> </canvas>
                            </div>
        </div>

        <div id='inspectorWrapper' class='inspectorWrapper'>

        </div>

        <button onclick='showInsp()' id='showInsp'> <i class="fa fa-sliders" aria-hidden="true"></i></button>
        <script src="./libs/fabric/fabric.js"></script>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
        <script src="./libs/custom/init.js"></script>
        <script src="./libs/custom/basics.js"></script>
        <script src="./libs/custom/doc.js"></script>
        <script src="./libs/custom/freeHand.js"></script>


        <script>
            function convertImgToDataURLviaCanvas(url, callback) {
                var img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = function() {
                    var canvas = document.createElement('CANVAS');
                    var ctx = canvas.getContext('2d');
                    canvas.height = this.height;
                    canvas.width = this.width;
                    var compositeOperation = ctx.globalCompositeOperation;
                    ctx.globalCompositeOperation = "destination-over";
                    ctx.fillStyle = "rgba(0,0,0,0)";
                    ctx.drawImage(this, 0, 0);
                    var dataURL = canvas.toDataURL("png");
                    callback(dataURL);
                    canvas = null;
                };
                img.src = url;
            }


            var url = window.location.hash.replace("#", "");
            /*document.getElementById("target").src = url;
            var dkrm;
            setTimeout("sstart()", 300);
            */

            var theCanvas = new fabric.Canvas('theCanvas');

            theCanvas.on('object:selected', function() {
              inspectorDisp.showActive();
            });
            theCanvas.on('selection:cleared', function() {
              if(CURRTOOL != null){
                inspectorDisp.show();
              }
            });

            function sstart() {
                dkrm = new Darkroom('#target', {
                    // Size options
                    minWidth: 200,
                    minHeight: 200,
                    maxWidth: window.innerWidth * .9,
                    maxHeight: window.innerHeight * .9,
                    // ratio: 4/3,
                    backgroundColor: 'transparent',

                    // Plugins options
                    plugins: {
                        save: false,
                        crop: {
                            quickCropKey: 67, //key "c"
                            minHeight: 50,
                            minWidth: 50,
                            //ratio: 4/3
                        }
                    },

                    // Post initialize script
                    initialize: function() {
                        sessionStorage.setItem("ie-data", dkrm.canvas.toDataURL());
                        var cropPlugin = this.plugins['crop'];
                        // cropPlugin.selectZone(170, 25, 300, 300);
                        //cropPlugin.requireFocus();
                        this.addEventListener('core:transformation', function() {
                            sessionStorage.setItem("ie-data", dkrm.canvas.toDataURL());
                            sessionStorage.setItem("ie-smp", "true");
                        });
                    }
                });
            }
        </script>

</body>

</html>
